<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>M3C Tools Listing</title>

    <!-- Font Awesome for neat icons. -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <!-- Roboto font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="m3c.css" />

    <!-- Promise polyfill to support Internet Explorer -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <!-- Fetch polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/whatwg-fetch@3.0.0/dist/fetch.umd.js"></script>
    <!-- URL polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/@ungap/url-search-params@0.1.2/min.js"></script>

    <style>
        .results .tags {
            padding-left: 0.25em;
        }
        .results .tags span {
            font-size: smaller;
            display: inline;
            padding-right: 0.75em;
            color: gray;
        }
    </style>
</head>

<body class="listing">

    <div class="container">

        <header>
            <a href="https://metabolomics.info/">
                <img alt="Metabolomics Info logo"
                    src="https://i2.wp.com/metabolomics.info/wp-content/uploads/2018/10/sepcc-logo-75.png?fit=60%2C60&ssl=1"
                    width=60 height=60>
                <div class="text">
                    <h1>Metabolomics Info</h1>
                    <p>Facilitating science through community</p>
                </div>
            </a>
            <div class="spacer"></div>
            <a id="menuToggle" aria-label="Toggle site navigation links">
                <i class="fas fa-fw fa-bars" aria-hidden="true"></i>
                <i class="fas fa-fw fa-times" aria-hidden="true"></i>
            </a>
            <nav>
                <a href="#content" class="sr-only">Skip to Content</a>
                <a href="index.html" class="dashboard-link current">
                    <h2>People Portal</h2>
                </a>
                <a href="https://metabolomics.info/about/">
                    <h2>About</h2>
                </a>
                <a href="https://metabolomics.info/events/">
                    <h2>Events</h2>
                </a>
                <a href="https://metabolomics.info/contact/">
                    <h2>Contact</h2>
                </a>
                <a href="https://metabolomics.info/consortium/">
                    <h2>NIH Consortium</h2>
                </a>
            </nav>
            <div class="sub-header">
                <nav class="sub-header">
                    <a class="sub-header-link" href="people.html">
                        <h2>People</h2>
                    </a>
                    <a class="sub-header-link" href="publications.html">
                        <h2>Publications</h2>
                    </a>
                    <a class="sub-header-link" href="projects.html">
                        <h2>Projects</h2>
                    </a>
                    <a class="sub-header-link" href="studies.html">
                        <h2>Studies</h2>
                    </a>
                    <a class="sub-header-link" href="organizations.html">
                        <h2>Organizations</h2>
                    </a>
                    <a class="sub-header-link current" href="tools.html">
                        <h2>Tools</h2>
                    </a>
                    <a class="sub-header-link" href="help.html">
                        <h2>Help</h2>
                    </a>
                </nav>
            </div>
        </header>

        <div id="content" class="page">
            <h1>Tools</h1>
            <div id="listing">
                <div class="controls">
                    <div class="count"></div>
                    <div class="fa fa-spinner fa-spin hidden"></div>
                    <div class="search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchFilter" placeholder="Search">
                    </div>
                </div>

                <div class="facets">
                    <div class="facet functionality">
                        <p>Functionality</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    <div class="facet instrumental">
                        <p>Instrumental Data Type</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    <div class="facet approach">
                        <p>Approach</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    <div class="facet language">
                        <p>Programming Language</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    <div class="facet type">
                        <p>Software Type</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                    <div class="facet tag">
                        <p>Tag</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>

                <ol class="results">
                    <!-- Templates aren't visible, but their clones are filled out with real data. -->
                    <li class="tool template">
                        <a href="#" class="link">
                            <div class="name"></div>
                        </a>
                        <div class="tags">
                            <span class="tag"></span>
                            <span class="functionality"></span>
                            <span class="instrumental"></span>
                            <span class="approach"></span>
                            <span class="language"></span>
                            <span class="type"></span>
                        </div>
                    </li>
                </ol>
            </div>
            <p class="disclaimer">
                Most of the data is from the
                <a href="https://raspicer.github.io/MetabolomicsTools/">Metabolomics Tools Wiki</a>
                <i class="fas fa-external-link-alt"></i>.
            </p>
        </div>

        <footer>
            <p>
                Metabolomics Info is an outreach portal to support the
                Metabolomics community.
            </p>
            <p>
                © 2020 Metabolomics&nbsp;Consortium Coordinating&nbsp;Center
            </p>
        </footer>

        <!-- Order matters; all dependencies for a module must be loaded first. -->
        <script src="tpf.js"></script>
        <script src="str.js"></script>
        <script src="m3c.js"></script>
        <script src="ui.js"></script>
        <script src="entity.js"></script>

        <script>
            const client = m3c.NewTPFClient()

            // Aliases for certain HTML elements
            const root = document.getElementById("listing")
            const results = root.querySelector(".results")
            const facets = root.querySelector(".facets")
            const search = root.querySelector("#searchFilter")
            const template = root.querySelector("li.tool.template")

            // Keep the results sorted.
            const sorted = ui.SortedList(results, 1, sortByName)


            ui.SortedList(facets.querySelector(".tag ul"), -1, sortByCount)
            ui.SortedList(facets.querySelector(".functionality ul"), -1, sortByCount)
            ui.SortedList(facets.querySelector(".instrumental ul"), -1, sortByCount)
            ui.SortedList(facets.querySelector(".approach ul"), -1, sortByCount)
            ui.SortedList(facets.querySelector(".language ul"), -1, sortByCount)
            ui.SortedList(facets.querySelector(".type ul"), -1, sortByCount)

            // Query the TPF server for all tools and some related data.
            const data = {
                tools: [],
                names: {}, // entity IRI => label string
                tags: {},  // tool IRI => list of tags
                functionalities: {},
                instrumentalDataTypes: {},
                approaches: {},
                languages: {},
                types: {},
            }

            const promises = [
                entity.Tools(client),
                entity.Names(client),
                entity.Tags(client),
                entity.ToolFunctionalities(client),
                entity.ToolInstrumentalDataTypes(client),
                entity.ToolApproaches(client),
                entity.ToolLanguages(client),
                entity.ToolTypes(client),
            ]

            Promise.all(promises)
                .then(function setData(results) {
                    data.tools = results[0]
                    data.names = results[1]
                    data.tags = results[2]
                    data.functionalities = results[3]
                    data.instrumentalDataTypes = results[4]
                    data.approaches = results[5]
                    data.languages = results[6]
                    data.types = results[7]

                    data.tools.forEach(renderTool)
                })
                .then(function automaticallyUpdateCount() {
                    if (data.tools.length > 5 + 1) {
                        const facetNodes = facets.querySelectorAll(".facet")
                        for (var i = 0; i < facetNodes.length; i++) {
                            const facet = facetNodes[i]
                            facet.className = (facet.className + " limit").trim()
                        }
                    }

                    const checkboxes = document.querySelectorAll(".facet input")
                    for (var i = 0; i < checkboxes.length; i++) {
                        checkboxes[i].addEventListener("click", updateResultCount)
                    }

                    search.addEventListener("keyup", updateResultCount)

                    updateResultCount()
                })

            // Setup the filters used by each facets. Each item should be a
            // function whose name matches the class name of the facet's HTML
            // element.
            const filters = {
                tag: function tag(selected, li) {
                    const tags = li.querySelectorAll(".tags .tag")
                    for (var j = 0; j < tags.length; j++) {
                        const tag = tags[j].innerText
                        for (var i = 0; i < selected.length; i++) {
                            if (tag === selected[i]) {
                                return true
                            }
                        }
                    }
                    return false
                },
                functionality: function functionality(selected, li) {
                    const functionalities = li.querySelector(".functionality")
                    return str.Contains(functionalities.innerText, selected)
                },
                instrumental: function instrumental(selected, li) {
                    const instrumentals = li.querySelector(".instrumental")
                    return str.Contains(instrumentals.innerText, selected)
                },
                approach: function approach(selected, li) {
                    const approaches = li.querySelector(".approach")
                    return str.Contains(approaches.innerText, selected)
                },
                language: function language(selected, li) {
                    const languages = li.querySelector(".language")
                    return str.Contains(languages.innerText, selected)
                },
                type: function type(selected, li) {
                    const types = li.querySelector(".type")
                    return str.Contains(types.innerText, selected)
                },
            }

            // Use facetsManager to dynamically increment the count of an option
            const facetsManager = ui.Facets(facets, results, filters, search)

            /**
             * Render a tool with the specified IRI.
             * @param {string} toolIRI
             */
            function renderTool(toolIRI) {
                const tags = data.tags[toolIRI] || []
                const functionalities = getProperty("functionalities")
                const instrumentals = getProperty("instrumentalDataTypes")
                const approaches = getProperty("approaches")
                const languages= getProperty("languages")
                const types = getProperty("types")

                const bindings = {
                    link: {
                        href: m3c.ProfileLink("tool", toolIRI.slice(1, -1)),
                    },
                    name: entity.ParseVIVOString(data.names[toolIRI]),
                    tag: tags,
                    functionality: functionalities,
                    instrumental: instrumentals,
                    approach: approaches,
                    language: languages,
                    type: types,
                }

                const li = ui.Render(template, bindings)

                const props = [
                    "tag", "functionality", "instrumental", "approach",
                    "language", "type"
                ]
                for (var i = 0; i < props.length; i++) {
                    const prop = props[i]
                    for (var j = 0; j < bindings[prop].length; j++) {
                        const tag = bindings[prop][j]
                        facetsManager.Increment(prop, tag, tag)
                    }
                }

                function getProperty(prop) {
                    if (!data[prop] || !data[prop][toolIRI]) {
                        return []
                    }
                    return data[prop][toolIRI].map(entity.ParseVIVOString)
                }
            }


            /**
             * Extract the count of a facet option; used for sorting.
             * @param {HTMLLIElement} li
             */
            function sortByCount(li) {
                return parseInt(li.querySelector(".count").innerText)
            }

            /**
             * Extract the name of a list item; used for sorting.
             * @param {HTMLLIElement} li
             */
            function sortByName(li) {
                const name = li.querySelector(".name").innerText.toUpperCase()
                return name
            }

            function updateResultCount() {
                const visible = document.querySelectorAll(".results li:not(.hidden):not(.template)")
                document.querySelector(".controls .count").innerText = visible.length
            }
        </script>
    </div>
</body>

</html>
