<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>M3C Publications Listing</title>

    <!-- Font Awesome for neat icons. -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <!-- Roboto font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="m3c.css" />

    <!-- Promise polyfill to support Internet Explorer -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <!-- Fetch polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/whatwg-fetch@3.0.0/dist/fetch.umd.js"></script>
    <!-- URL polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/@ungap/url-search-params@0.1.2/min.js"></script>

    <style>
        .disclaimer {
            padding: 0.1em 1em;
            text-align: left;
        }

        .citation {
            font-size: smaller;
        }

        .publication .year,
        .publication .authors {
            display: inline-block;
            padding-right: 0.5em;
        }

        .authors a {
            margin-left: 0.25em;
            margin-right: 0.25em;
        }
    </style>
</head>

<body class="listing">

    <div class="container">

        <header>
            <a href="https://metabolomics.info/">
                <img alt="Metabolomics Info logo"
                    src="https://i2.wp.com/metabolomics.info/wp-content/uploads/2018/10/sepcc-logo-75.png?fit=60%2C60&ssl=1"
                    width=60 height=60>
                <div class="text">
                    <h1>Metabolomics Info</h1>
                    <p>Facilitating science through community</p>
                </div>
            </a>
            <div class="spacer"></div>
            <a id="menuToggle" aria-label="Toggle site navigation links">
                <i class="fas fa-fw fa-bars" aria-hidden="true"></i>
                <i class="fas fa-fw fa-times" aria-hidden="true"></i>
            </a>
            <nav>
                <a href="#content" class="sr-only">Skip to Content</a>
                <a href="index.html" class="dashboard-link current">
                    <h2>People Portal</h2>
                </a>
                <a href="https://metabolomics.info/about/">
                    <h2>About</h2>
                </a>
                <a href="https://metabolomics.info/events/">
                    <h2>Events</h2>
                </a>
                <a href="https://metabolomics.info/contact/">
                    <h2>Contact</h2>
                </a>
                <a href="https://metabolomics.info/consortium/">
                    <h2>NIH Consortium</h2>
                </a>
            </nav>
            <div class="sub-header">
                <nav class="sub-header">
                    <a class="sub-header-link" href="people.html">
                        <h2>People</h2>
                    </a>
                    <a class="sub-header-link current" href="publications.html">
                        <h2>Publications</h2>
                    </a>
                    <a class="sub-header-link" href="projects.html">
                        <h2>Projects</h2>
                    </a>
                    <a class="sub-header-link" href="studies.html">
                        <h2>Studies</h2>
                    </a>
                    <a class="sub-header-link" href="organizations.html">
                        <h2>Organizations</h2>
                    </a>
                    <a class="sub-header-link" href="tools.html">
                        <h2>Tools</h2>
                    </a>
                    <a class="sub-header-link" href="help.html">
                        <h2>Help</h2>
                    </a>
                </nav>
            </div>
        </header>

        <div id="content" class="page">
            <h1>PubMed Publications</h1>
            <div id="listing">
                <div class="controls">
                    <div class="count"></div>
                    <div class="fa fa-spinner fa-spin hidden"></div>
                    <div class="search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchFilter" placeholder="Search">
                    </div>
                </div>

                <div class="facets">
                    <div class="facet published">
                        <p>Year Published</p>
                        <div class="facet-controls">
                            <!-- <a href="#" class="show">Show all</a> -->
                            <!-- <a href="#" class="limit">Show fewer</a> -->
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>

                    <p class="disclaimer">
                        Publication information from
                        <a href="https://www.ncbi.nlm.nih.gov/pubmed/">PubMed</a>
                        <i class="fas fa-external-link-alt"></i>.
                        <br />
                        <a href="https://github.com/ctsit/m3c-web/issues">Report an issue</a>
                    </p>
                </div>

                <ol class="results">
                    <!-- Templates aren't visible, but their clones are filled out with real data. -->
                    <li class="publication template">
                        <div>
                            <a href="#" class="name link"
                                target="_blank" rel="noopener noreferrer"></a>
                            <i class="fas fa-external-link-alt"></i>
                        </div>
                        <div class="year"></div>
                        <i class="fas fa-users" aria-label="Authors"></i>
                        <div class="authors"></div>
                        <a href="#" class="cite">
                            <i class="fas fa-quote-right" aria-hidden="true"></i>
                            Cite
                        </a>
                        <div class="citation hidden"></div>
                    </li>
                </ol>
            </div>
        </div>

        <footer>
            <p>
                Metabolomics Info is an outreach portal to support the
                Metabolomics community.
            </p>
            <p>
                Â© 2020 Metabolomics&nbsp;Consortium Coordinating&nbsp;Center
            </p>
        </footer>

        <!-- Order matters; all dependencies for a module must be loaded first. -->
        <script src="tpf.js"></script>
        <script src="str.js"></script>
        <script src="m3c.js"></script>
        <script src="ui.js"></script>
        <script src="entity.js"></script>

        <script>
            const client = m3c.NewTPFClient()

            const uiCount = document.querySelector(".controls .count")
            const uiRoot = document.getElementById("listing")
            const uiResults = uiRoot.querySelector(".results")
            const uiFacets = uiRoot.querySelector(".facets")
            const uiTemplate = uiRoot.querySelector("li.publication.template")
            const uiSearch = uiRoot.querySelector("#searchFilter")
            const uiUncheckAll = uiFacets.querySelector(".published .reset")

            const state = {
                limit: 100,
                dirty: 0,
                loading: false,

                years: {},
                yearsSelected: [],

                query: "",
                filtered: [],

                publications: [],
                names: {},
                published: {},
                authors: {},
                citations: {},
                authorsNames: {},
            }

            uiSearch.addEventListener("keyup", handleSearchChange)
            uiUncheckAll.addEventListener("click", handleUncheckAll)

            fetchData()
            .then(render)


            function fetchData() {
                update({ loading: true })

                return Promise.all([
                    entity.Publications(client),
                    entity.Names(client),
                    entity.PublicationDates(client),
                ])
                .then(function (data) {
                    const pubs = data[0]
                    const names = data[1]
                    const dates = data[2]

                    update({
                        publications: pubs,
                        published: dates,
                    })

                    pubs.sort(function (a, b) {
                        return dates[b] > dates[a]
                    })

                    for (const uri in names) {
                        names[uri] = entity.ParseVIVOString(names[uri])
                    }

                    update({
                        names: names,
                        publications: pubs,
                        filtered: pubs,
                    })

                    /** @type {{[uri: string]: string[]}} */
                    const years = {}
                    const older = "1999 and earlier"
                    for (const uri in dates) {
                        var year = dates[uri].slice(0, "2012".length)
                        if (year < "2000") {
                            year = older
                        }
                        if (!years[year]) {
                            years[year] = []
                        }
                        years[year].push(uri)
                    }
                    update({ years: years }, renderFacets)

                }, console.error)
                .then(function () {
                    return entity.Citations(client)
                })
                .then(function (citations) {
                    update({ citations: citations })
                })
                .then(function () {
                    return entity.Authorships(client)
                })
                .then(function (authorships) {
                    /** @type {{[uri: string]: string[]}} PMID => Author List */
                    const authors = {}
                    const authorsNames = {}

                    for (const authorshipIRI in authorships) {
                        const relates = authorships[authorshipIRI]

                        // Unfortunately, the pub-person pair could be in either
                        // order. If the IRI contains "pmid", it's for the Pub.
                        var pubIRI = relates[0]
                        var personIRI = relates[1]
                        if (relates[0].indexOf("pmid") === -1) {
                            personIRI = relates[0]
                            pubIRI = relates[1]
                        }

                        if (!authors[pubIRI]) {
                            authors[pubIRI] = []
                            authorsNames[pubIRI] = []
                        }

                        authors[pubIRI].push(personIRI)
                        authorsNames[pubIRI].push(state.names[personIRI])
                    }

                    update({
                        authors: authors,
                        authorsNames: authorsNames,
                    })
                })
                .catch(console.error)
                .then(function () {
                    update({ loading: false })
                })
            }

            /** @param {MouseEvent} click */
            function handleFacetClick(click) {
                const year = click.target.value
                const checked = click.target.checked
                if (checked) {
                    refilter(state.query, state.yearsSelected.concat([year]))
                    return
                }
                const s = state.yearsSelected
                const i = s.indexOf(year)
                const selected = s.slice(0,i).concat(s.slice(i+1))
                refilter(state.query, selected)
            }

            /** @param {KeyboardEvent} keyup */
            function handleSearchChange(keyup) {
                if (keyup.isComposing || keyup.keyCode === 229) {
                    // Ignore IME composition
                    // @see https://developer.mozilla.org/en-US/docs/Web/API/Document/keyup_event
                    return
                }
                refilter(uiSearch.value, state.yearsSelected)
            }

            function handleUncheckAll() {
                refilter(state.query, [], renderFacets)
            }

            function refilter(query, yearsSelected, callback) {
                var pubs = state.publications
                if (yearsSelected.length > 0) {
                    pubs = []
                    yearsSelected.sort().reverse()
                    for (var i = 0; i < yearsSelected.length; i++) {
                        const year = yearsSelected[i]
                        pubs = pubs.concat(state.years[year])
                    }
                }

                const q = query.toUpperCase()
                var filtered = pubs
                if (q) {
                    filtered = []
                    for (var i = 0; i < pubs.length; i++) {
                        const uri = pubs[i]
                        const title = state.names[uri].toUpperCase()
                        if (title.indexOf(q) !== -1) {
                            filtered.push(uri)
                            continue
                        }

                        const authors = state
                            .authorsNames[uri]
                            .join(", ")
                            .toUpperCase()

                        if (authors.indexOf(q) !== -1) {
                            filtered.push(uri)
                            continue
                        }
                    }
                }

                update({
                    query: query,
                    yearsSelected: yearsSelected,
                    filtered: filtered,
                }, callback)
            }

            function render() {
                // Clear previous rendering.
                uiResults.innerHTML = ""
                if (state.loading) {
                    uiCount.innerHTML =
                        '<i class="fas fa-spinner fa-spin"' +
                        '   aria-hidden="true" title="Loading...">' +
                        '</i>'
                }

                // Render Publications Listing.
                const fragment = document.createDocumentFragment()

                const pubs = state.filtered
                var items = pubs
                if (state.limit) {
                   items = items.slice(0, state.limit)
                }
                items = items.map(renderPublication)
                items.forEach(function (li) { fragment.appendChild(li) })
                uiResults.appendChild(fragment)

                if (!state.loading) {
                    renderCount(uiCount, items.length, pubs.length)
                }
            }

            function renderCount(uiCount, numItems, numPubs) {
                if (numItems === numPubs) {
                    uiCount.innerHTML = numPubs
                    return
                }

                uiCount.innerHTML =
                    str.Format("{} of {} shown ", numItems, numPubs)

                const a = document.createElement("a")
                a.href = "#"
                a.innerText = "(Load all publications)"
                a.addEventListener("click", handleLoadAllClick)
                uiCount.appendChild(a)

                function handleLoadAllClick(e) {
                    uiCount.innerHTML =
                        "<i>Loading all publications. This may take some time...</i>"
                    update({ limit: null })
                }
            }

            function renderFacets() {
                const yearFacet = uiFacets.querySelector(".published")
                const options = yearFacet.querySelector(".published ul")
                const template = options.querySelector(".template")
                options.innerHTML = ""

                const fragment = document.createDocumentFragment()

                var years = Object.keys(state.years).sort().reverse()
                for (var i = 0; i < years.length; i++) {
                    const year = years[i]
                    const bindings = {
                        box: {
                            value: year,
                            onclick: handleFacetClick,
                        },
                        name: year,
                        count: state.years[year].length,
                    }

                    const item = ui.Build(template, bindings)

                    fragment.appendChild(item)
                }

                options.appendChild(template)
                options.appendChild(fragment)
            }

            function renderPublication(publicationIRI) {
                const authorIRIs = state.authors[publicationIRI] || []
                const published = state.published[publicationIRI]
                const citation = state.citations[publicationIRI]

                const authors = document.createElement("div")
                for (var i = 0; i < authorIRIs.length; i++) {
                    const authorIRI = authorIRIs[i]
                    const name = state.names[authorIRI]
                    if (!name) {
                        // Filter out nameless authors. This can happen with
                        // withheld records.
                        continue
                    }
                    const a = document.createElement("a")
                    a.href = m3c.ProfileLink("person", authorIRI)
                    a.innerText = state.names[authorIRI]
                    authors.appendChild(a)
                }

                const bindings = {
                    link: {
                        href: m3c.ProfileLink("publication", publicationIRI.slice(1, -1)),
                    },
                    name: state.names[publicationIRI],
                    year: published ? published : null,
                    authors: authors.innerHTML,
                    citation: citation ? entity.ParseVIVOString(citation) : ""
                }

                const li = ui.Build(uiTemplate, bindings)

                const cite = li.querySelector(".cite")
                if (!citation) {
                    cite.className += " hidden"
                } else {
                    cite.addEventListener("click", function (click) {
                        click.preventDefault()
                        cite.className += " hidden"
                        const c = li.querySelector(".citation")
                        c.className = c.className.replace("hidden", "")
                    })
                }

                return li
            }

            function update(values, callback) {
                clearTimeout(state.dirty)
                for (const prop in values) {
                    state[prop] = values[prop]
                }
                state.dirty = setTimeout(render, 100)
                if (callback) {
                    callback()
                }
            }
        </script>
    </div>
</body>

</html>
