<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>M3C People Listing</title>

    <!-- Font Awesome for neat icons. -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <!-- Roboto font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="m3c.css" />

    <!-- Promise polyfill to support Internet Explorer -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <!-- Fetch polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/whatwg-fetch@3.0.0/dist/fetch.umd.js"></script>
    <!-- URL polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/@ungap/url-search-params@0.1.2/min.js"></script>

    <style>
        .listing ol.results li div {
            padding-left: 80px;
        }

        .listing ol.results li  {
            min-height: 100px;
        }
    </style>

</head>

<body class="listing">

    <div class="container">

        <header>
            <a href="https://metabolomics.info/">
                <img alt="Metabolomics Info logo"
                    src="https://i2.wp.com/metabolomics.info/wp-content/uploads/2018/10/sepcc-logo-75.png?fit=60%2C60&ssl=1"
                    width=60 height=60>
                <div class="text">
                    <h1>Metabolomics Info</h1>
                    <p>Facilitating science through community</p>
                </div>
            </a>
            <div class="spacer"></div>
            <a id="menuToggle" aria-label="Toggle site navigation links">
                <i class="fas fa-fw fa-bars" aria-hidden="true"></i>
                <i class="fas fa-fw fa-times" aria-hidden="true"></i>
            </a>
            <nav>
                <a href="#content" class="sr-only">Skip to Content</a>
                <a href="index.html" class="dashboard-link current">
                    <h2>People Portal</h2>
                </a>
                <a href="https://metabolomics.info/about/">
                    <h2>About</h2>
                </a>
                <a href="https://metabolomics.info/events/">
                    <h2>Events</h2>
                </a>
                <a href="https://metabolomics.info/contact/">
                    <h2>Contact</h2>
                </a>
                <a href="https://metabolomics.info/consortium/">
                    <h2>NIH Consortium</h2>
                </a>
            </nav>
            <div class="sub-header">
                <nav class="sub-header">
                    <a class="sub-header-link current" href="people.html">
                        <h2>People</h2>
                    </a>
                    <a class="sub-header-link" href="publications.html">
                        <h2>Publications</h2>
                    </a>
                    <a class="sub-header-link" href="projects.html">
                        <h2>Projects</h2>
                    </a>
                    <a class="sub-header-link" href="studies.html">
                        <h2>Studies</h2>
                    </a>
                    <a class="sub-header-link" href="organizations.html">
                        <h2>Organizations</h2>
                    </a>
                    <a class="sub-header-link" href="tools.html">
                        <h2>Tools</h2>
                    </a>
                    <a class="sub-header-link" href="help.html">
                        <h2>Help</h2>
                    </a>
                </nav>
            </div>
        </header>

        <div id="content" class="page">
            <h1>People</h1>
            <div id="listing">
                <div class="controls">
                    <div class="count"></div>
                    <div class="fa fa-spinner fa-spin hidden"></div>
                    <div class="search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchFilter" placeholder="Search">
                    </div>
                </div>

                <div class="facets">
                    <div class="facet organization">
                        <p>Institute</p>
                        <div class="facet-controls">
                            <a href="#" class="show">Show all</a>
                            <a href="#" class="limit">Show fewer</a>
                            <a href="#" class="reset">Uncheck all</a>
                        </div>
                        <ul>
                            <li class="template">
                                <label>
                                    <input type="checkbox" class="box" />
                                    <span class="name"></span>
                                    <span class="count"></span>
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>

                <ol class="results">
                    <!-- Templates aren't visible, but their clones are filled out with real data. -->
                    <li class="person template">
                        <a href="#" class="link">
                            <img class="photo" width="64" height="64"
                                src="https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png" />
                            <div class="name"></div>
                        </a>
                        <div>
                            <i class="fas fa-city"></i>
                            <span class="organization"></span>
                        </div>
                    </li>
                </ol>
            </div>
        </div>

        <footer>
            <p>
                Metabolomics Info is an outreach portal to support the
                Metabolomics community.
            </p>
            <p>
                Â© 2020 Metabolomics&nbsp;Consortium Coordinating&nbsp;Center
            </p>
        </footer>

        <!-- Order matters; all dependencies for a module must be loaded first. -->
        <script src="tpf.js"></script>
        <script src="str.js"></script>
        <script src="m3c.js"></script>
        <script src="ui.js"></script>
        <script src="entity.js"></script>

        <script>
            const client = m3c.NewTPFClient()

            // Aliases for certain HTML elements
            const uiCount = document.querySelector(".controls .count")
            const uiRoot = document.getElementById("listing")
            const uiResults = uiRoot.querySelector(".results")
            const uiFacets = uiRoot.querySelector(".facets")
            const search = uiRoot.querySelector("#searchFilter")
            const uiPersonTemplate = uiRoot.querySelector("li.person.template")

            // Keep the results sorted.
            const sorted = ui.SortedList(uiResults, 1, sortLastFirst)

            ui.SortedList(uiFacets.querySelector(".organization ul"), -1, sortByCount)

            // Query the TPF server for all people and some related data.
            const state = {
                persons: [],
                associatedWith: {}, // person IRI => org IRI
                names: {}, //          entity IRI => label string
                institutes: [], //     list of institute IRIs
                mainImages: {},
                downloadLocations: {},
                directDownloadUrls: {},
                personToURL: {}
            }
            fetchData()
                .then(render)

            function fetchData() {
                update({loading: true})

                return Promise.all([
                    entity.Persons(client),
                    entity.AssociatedWiths(client),
                    entity.Names(client),
                    entity.Institutes(client),
                    entity.MainImages(client),
                    entity.DownloadLocations(client),
                    entity.DirectDownloadUrls(client)
                ])
                    .then(function setData(data) {
                        const person = data[0]
                        const associatedWith = data[1]
                        const names = data[2]
                        const institutes = data[3]
                        const mainImages = data[4]
                        const downloadLocations = data[5]
                        const directDownloadUrls = data[6]

                        update({
                            persons: person,
                            associatedWith: associatedWith,
                            institutes: institutes,
                            mainImages: mainImages,
                            downloadLocations: downloadLocations,
                            directDownloadUrls: directDownloadUrls
                        })

                        for (const uri in names) {
                            names[uri] = entity.ParseVIVOString(names[uri])
                        }
                        update({names: names})

                        state.persons.forEach(function(uri) {
                            const mainImage = state.mainImages[uri]
                            if (!mainImage) {
                                return
                            }

                            const downloadLocation = state.downloadLocations[mainImage]
                            const directURL = state.directDownloadUrls[downloadLocation]
                            state.personToURL[uri] = directURL[0].slice(1, -1)
                        })

                        state.persons.forEach(renderPerson)
                    })
                    .then(function limitFacetItems() {
                        if (state.persons.length > 5 + 1) {
                            const orgfacet = uiRoot.querySelector(".facet.organization")
                            orgfacet.className = (orgfacet.className + " limit").trim()
                        }
                    })
                    .then(function() {
                        updateResultCount
                        update({loading: false})
                    })
            }

            // Setup the filters used by each facets. Each item should be a
            // function whose name matches the class name of the facet's HTML
            // element.
            const filters = {
                organization: function organization(selected, li) {
                    const org = li.querySelector(".organization")
                    return selected.indexOf(org.innerText) !== -1
                },
            }

            // Use facetsManager to dynamically increment the count of an option
            const facetsManager = ui.Facets(
                uiFacets, uiResults, filters, search, updateResultCount
            )

            function render() {
                // Clear previous rendering.
                uiResults.innerHTML = ""
                /* eslint-disable quotes */
                if (state.loading) {
                    uiCount.innerHTML =
                        '<i class="fas fa-spinner fa-spin"' +
                        '   aria-hidden="true" title="Loading...">' +
                        '</i>'
                }
                /* eslint-enable quotes */
                // Render Person Listing.
                const fragment = document.createDocumentFragment()

                const persons = state.persons
                let items = persons
                items = items.map(renderPerson)
                items.forEach(function(li) {
                    fragment.appendChild(li)
                })

                uiResults.appendChild(fragment)

                if (!state.loading) {
                    updateResultCount()
                }
            }


            /**
             * Render a person with the specified IRI.
             * @param {string} personIRI
             * @return {li} list of rendered Persons
             */
            function renderPerson(personIRI) {
                const person = entity.Person(client, personIRI.slice(1, -1))
                const associations = state.associatedWith[personIRI] || []
                let orgIRI = null
                for (var i = 0; i < associations.length; i++) {
                    if (state.institutes.indexOf(associations[i]) !== -1 ) {
                        orgIRI = associations[i]
                        break
                    }
                }

                const bindings = {
                    link: {
                        href: m3c.ProfileLink("person", personIRI),
                    },
                    name: entity.ParseVIVOString(state.names[personIRI]),
                    photo: {
                        alt: state.names[personIRI],
                        src: getPhoto,
                    },
                    organization: orgIRI ? state.names[orgIRI] : null,
                }

                const li = ui.Build(uiPersonTemplate, bindings)
            
                if (orgIRI) {
                    facetsManager.Increment("organization", bindings.organization, bindings.organization)
                }

                function getPhoto(callback) {
                    const url = state.personToURL[personIRI]
                    if (!url) {
                        return
                    }
                    callback(m3c.PhotoURL(client.Endpoint, url))
                }
                return li
            }

            /**
             * Extract the name of a list item; used for sorting.
             * @param {HTMLLIElement} li
             * @return {lastFirst} list ordered by lastname first
             */
            function sortLastFirst(li) {
                const firstLast = li.querySelector(".name").innerText.toUpperCase()
                const lastFirst = firstLast.split(" ").reverse().join(" ")
                return lastFirst
            }

            /**
             * Extract the count of a facet option; used for sorting.
             * @param {HTMLLIElement} li
             * @return {int}
             */
            function sortByCount(li) {
                return parseInt(li.querySelector(".count").innerText)
            }

            function updateResultCount() {
                const visible = document.querySelectorAll(".results li:not(.hidden):not(.template)")
                document.querySelector(".controls .count").innerText = visible.length
            }

            function update(values, callback) {
                clearTimeout(state.dirty)
                for (const prop in values) {
                    state[prop] = values[prop]
                }
                state.dirty = setTimeout(render, 100)
                if (callback) {
                    callback()
                }
            }
        </script>
    </div>
</body>

</html>
